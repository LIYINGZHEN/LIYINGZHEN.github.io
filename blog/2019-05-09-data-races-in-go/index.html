<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
    content="     &#34;Max&#34;">
<meta name="description"
    content="Go is known for how easy it is to build concurrent programs in it. But, with all this concurrency, comes the possibility of the dreaded data race — one of the hardest bugs to debug if you’re ever unfortunate enough to encounter it in your code.
In this post, we will go through a sample program that causes a data race, and detect the race condition with the race detector tool." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://www.maxlivinci.com/blog/2019-05-09-data-races-in-go/" />


<title>
    
    Data races in Go :: MAX LI 
    
</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="https://www.maxlivinci.com/main.min.6a7678f40434c7781747ffdd224a984179b2a3c81c81f19ccf845fdffbe80b7c.css">



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#252627">
<link rel="shortcut icon" href="/favicon.ico">
<meta name="theme-color" content="#252627">
<meta itemprop="name" content="Data races in Go">
<meta itemprop="description" content="Go is known for how easy it is to build concurrent programs in it. But, with all this concurrency, comes the possibility of the dreaded data race — one of the hardest bugs to debug if you’re ever unfortunate enough to encounter it in your code.
In this post, we will go through a sample program that causes a data race, and detect the race condition with the race detector tool.">


<meta itemprop="datePublished" content="2019-05-09T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-05-09T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1119">



<meta itemprop="keywords" content="go," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://www.maxlivinci.com"/>

<meta name="twitter:title" content="Data races in Go"/>
<meta name="twitter:description" content="Go is known for how easy it is to build concurrent programs in it. But, with all this concurrency, comes the possibility of the dreaded data race — one of the hardest bugs to debug if you’re ever unfortunate enough to encounter it in your code.
In this post, we will go through a sample program that causes a data race, and detect the race condition with the race detector tool."/>




<meta property="article:published_time" content="2019-05-09 00:00:00 &#43;0000 &#43;0000" />







    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">cd $HOME</span>
            <span class="logo__cursor"></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://www.maxlivinci.com/about">About</a></li><li><a href="https://www.maxlivinci.com/blog">Blog</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>6 minutes

            

            </p>
        </div>

        <article>
            <h1 class="post-title"><a href="https://www.maxlivinci.com/blog/2019-05-09-data-races-in-go/">Data races in Go</a></h1>

            

            <div class="post-content">
                

<p>Go is known for how easy it is to build concurrent programs in it. But, with all this concurrency, comes the possibility of the dreaded data race — one of the hardest bugs to debug if you’re ever unfortunate enough to encounter it in your code.</p>

<p>In this post, we will go through a sample program that causes a data race, and detect the race condition with the <a href="https://golang.org/doc/articles/race_detector.html">race detector</a> tool. We will then look at some of the methods to get around and solve the race condition, while still keeping the core logic of our code intact.</p>

<h2 id="the-data-race">The data race</h2>

<p>Rather than explaining what a data race is, let’s look at a sample piece of code:</p>

<pre><code class="language-go">func main() {
	fmt.Println(getNumber())
}

func getNumber() int {
	var i int
	go func() {
		i = 5
	}()

	return i
}
</code></pre>

<p><a href="https://play.golang.org/p/TvaREY1QDFx">Try it here</a></p>

<p>Here, we can see that the <code>getNumber</code> function is setting the value of <code>i</code> in a separate goroutine. We are also returning i from the function without any knowledge of whether our goroutine has completed or not. So now, there are two operations that are taking place:</p>

<p>The value of <code>i</code> is being set to <code>5</code>
The value of <code>i</code> is being returned from the function
Now depending on which of these two operations completes first, our value printed will be either <code>0</code> (the default integer value) or <code>5</code>.</p>

<p>This is why it’s called a data race : the value returned from <code>getNumber</code> changes depending on which of the operations <code>1</code> or <code>2</code> finish first.</p>

<p><img src="https://www.sohamkamani.com/datarace1-f381f099898b2cd7389019a427e53da8.svg" alt="" /></p>

<p>👆 Data race with read finishing first</p>

<p><img src="https://www.sohamkamani.com/datarace2-19c7b8cc43a260dd7f476365d276455d.svg" alt="" /></p>

<p>👆 Data race with write finishing first</p>

<p>As you can imagine, its horrible having to test and use code which acts differently every single time you call it, and this is why data races pose such a huge problem.</p>

<h2 id="detecting-a-data-race">Detecting a data race</h2>

<p>The code we went through is a highly simplified example of a data race in action. In larger applications, a data race is much harder to detect on your own. Fortunately for us, Go (as of v1.1) has an inbuilt data race detector that we can use to pin point potential data race conditions.</p>

<p>Using it is as simple as adding a <code>-race</code> flag to your normal Go command line tools.</p>

<p>For example, let’s try to run the program we just wrote by using the <code>-race</code> flag:</p>

<pre><code>go run -race main.go
</code></pre>

<p>This is what I got as the output:</p>

<pre><code>0
==================
WARNING: DATA RACE
Write at 0x00c420086008 by goroutine 6:
  main.getNumber.func1()
      /Users/soham/go/src/tmp/main.go:15 +0x3b

Previous read at 0x00c420086008 by main goroutine:
  main.getNumber()
      /Users/soham/go/src/tmp/main.go:17 +0x8e
  main.main()
      /Users/soham/go/src/tmp/main.go:9 +0x33

Goroutine 6 (running) created at:
  main.getNumber()
      /Users/soham/go/src/tmp/main.go:14 +0x7d
  main.main()
      /Users/soham/go/src/tmp/main.go:9 +0x33
==================
Found 1 data race(s)
exit status 66
</code></pre>

<p>The first <code>0</code> is the printed result (so we now know that operation 2 finished first). The next few lines give us information about the data race that was detected in out code. (The line numbers may not correspond to the sample code above since the actual code will have imports and package declarations)</p>

<p>We can see that the information about our data race is divided into three sections:</p>

<ol>
<li>The first section tells us that there was an attempted write inside a goroutine that we created (which is where we assign the value <code>5</code> to <code>i</code>)</li>
<li>The next section tells us that was a simultaneous read by the main goroutine, which in our code, traces through the return statement and the print statement.</li>
<li>The third section describes where the goroutine that caused (1) was created.
So, just by adding a <code>-race</code> flag, the <code>go run</code> command has explained exactly what I explained in the previous section about the data race.</li>
</ol>

<p>The <code>-race</code> flag can also be added to the <code>go build</code> and <code>go test</code> commands.</p>

<p>It’s so easy to detect a potential race condition in Go, that I can’t think of any reason not to include the <code>-race</code> flag when building your Go application. The benefits far outweigh the costs(if there even are any) and can contribute to a much more robust application.</p>

<h2 id="fixing-data-races">Fixing data races</h2>

<p>Once you finally find that annoying data race, you’ll be glad to know that Go offers many options to fix it. All of these solutions help to ensure that access to the variable in question is blocked if we are writing to it.</p>

<h3 id="blocking-with-waitgroups">Blocking with waitgroups</h3>

<p>The most straightforward way of solving a data race, is to block read access until the write operation has been completed:</p>

<pre><code class="language-go">func getNumber() int {
	var i int
	// Initialize a waitgroup variable
	var wg sync.WaitGroup
	// `Add(1) signifies that there is 1 task that we need to wait for
	wg.Add(1)
	go func() {
		i = 5
		// Calling `wg.Done` indicates that we are done with the task we are waiting fo
		wg.Done()
	}()
	// `wg.Wait` blocks until `wg.Done` is called the same number of times
	// as the amount of tasks we have (in this case, 1 time)
	wg.Wait()
	return i
}
</code></pre>

<p><a href="https://play.golang.org/p/RHbGQOI3cUv">Try it here</a></p>

<p><img src="https://www.sohamkamani.com/wg-8a9641c4bfb1f4c169ea91891b4d0e27.svg" alt="" /></p>

<h3 id="blocking-with-channels">Blocking with channels</h3>

<p>This method is similar in principle to the last one, except we use channels instead of waitgroups:</p>

<pre><code class="language-go">func getNumber() int {
	var i int
	// Create a channel to push an empty struct to once we're done
	done := make(chan struct{})
	go func() {
		i = 5
		// Push an empty struct once we're done
		done &lt;- struct{}{}
	}()
	// This statement blocks until something gets pushed into the `done` channel
	&lt;-done
	return i
}
</code></pre>

<p><a href="https://play.golang.org/p/oSnM7_7gI3X">Try it here</a></p>

<p><img src="https://www.sohamkamani.com/blockchannel-80dcff0c671bc778b54340aceefae777.svg" alt="" /></p>

<p>Blocking inside the <code>getNumber</code> function, although simple, would get troublesome if we want to call the function repeatedly. The next method follows a more flexible approach towards blocking.</p>

<h3 id="returning-a-channel">Returning a channel</h3>

<p>Instead of using channels to block the function, we could return a channel through which we push our result, once we have it. Unlike the previous two methods, this method does not do any blocking on its own. Instead it leaves the decision of blocking up to the calling code.</p>

<pre><code class="language-go">// return an integer channel instead of an integer
func getNumberChan() &lt;-chan int {
	// create the channel
	c := make(chan int)
	go func() {
		// push the result into the channel
		c &lt;- 5
	}()
	// immediately return the channel
	return c
}
</code></pre>

<p>Then, you can get the result from the channel in the calling code:</p>

<pre><code class="language-go">func main() {
	// The code is blocked until something gets pushed into the returned channel
	// As opposed to the previous method, we block in the main function, instead
	// of the function itself
	i := &lt;-getNumberChan()
	fmt.Println(i)
}
</code></pre>

<p><a href="https://play.golang.org/p/POYn3UalH3e">Try it here</a></p>

<p><img src="https://www.sohamkamani.com/returnchannel-3b129c89d38b8c17bdbd2b2939b20b19.svg" alt="" /></p>

<p>This approach is more flexible because it allows higher level functions to decide their own blocking and concurrency mechanisms, instead of treating the getNumber function as synchronous.</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://www.maxlivinci.com/tags/go">go</a></span>
                </p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>1119 Words</p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2019-05-09 08:00 &#43;0800</p>
        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h">Read other posts</span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    
                        <span class="button previous">
                            <a href="https://www.maxlivinci.com/blog/2019-05-10-functional-options/">
                                <span class="button__icon">←</span>
                                <span class="button__text">Functional options</span>
                            </a>
                        </span>
                    

                    
                        <span class="button next">
                            <a href="https://www.maxlivinci.com/blog/2019-05-08-standard-package-layout/">
                                <span class="button__text">Standard Package Layout</span>
                                <span class="button__icon">→</span>
                            </a>
                        </span>
                    
                </div>
            </div>
        

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2018 - 2019</span>
            
                <span>Max Li</span>
            
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">

        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="https://www.maxlivinci.com/bundle.min.cf7871ed49474a80ed457154d24e61f7881adbe0f9384951a74ac46b688a39a4dbfa68bc6d37baeb058186de354ead3487d4ee7f083ea4cba860c48600b694f3.js" integrity="sha512-z3hx7UlHSoDtRXFU0k5h94ga2&#43;D5OElRp0rEa2iKOaTb&#43;mi8bTe66wWBht41Tq00h9Tufwg&#43;pMuoYMSGALaU8w=="></script>



    </body>
</html>
